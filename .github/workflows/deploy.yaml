name: Arch Linux
on:
  push:
    branches: [master]
jobs:
  arch:
    runs-on: ubuntu-latest
    container: archlinux
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update repositories and install essentials
        run: |
          pacman -Syyu --noconfirm
          pacman -S --noconfirm git base-devel sudo xorg-xrandr openssh
          pacman --noconfirm --ask=4 -S iptables-nft

          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder $(pwd)
      - uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.ACTIONS_AUR_SSH_KEY }}
      - name: Configure git
        run: |
          su builder -c "git config --global user.name Madman10K"
          su builder -c "git config --global user.email contact@madladsquad.com"
          su builder -c "git config --global init.defaultBranch main"
          
          su builder -c "mkdir -p ~/.ssh" || exit
          su builder -c "ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts" || exit
      - name: Compile
        run: su builder -c "./run.sh deploy"
